image: node:20

stages:
  - test
  - build
  - release

variables:
  PNPM_VERSION: "8"
  RUST_VERSION: "stable"
  CARGO_HOME: "$CI_PROJECT_DIR/.cargo"
  RUSTUP_HOME: "$CI_PROJECT_DIR/.rustup"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .pnpm-store/
    - .cargo/
    - .rustup/
    - src-tauri/target/

before_script:
  - corepack enable
  - corepack prepare pnpm@${PNPM_VERSION} --activate
  - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain ${RUST_VERSION}
  - source $HOME/.cargo/env
  - rustup default ${RUST_VERSION}

test:
  stage: test
  image: node:20
  script:
    - pnpm install --frozen-lockfile
    - pnpm lint
    - pnpm format:check
    - pnpm test --run
  only:
    - merge_requests
    - main
    - tags

test:rust:
  stage: test
  image: rust:latest
  script:
    - cd src-tauri
    - cargo test --verbose
  only:
    - merge_requests
    - main
    - tags

build:windows:
  stage: build
  image: mcr.microsoft.com/windows/servercore:ltsc2022
  tags:
    - windows
    - docker
  before_script:
    - choco install -y nodejs-lts pnpm rust
    - refreshenv
  script:
    - pnpm install --frozen-lockfile
    - pnpm build
    - cd src-tauri
    - cargo build --release
    - cargo tauri build --bundles nsis,msi
  artifacts:
    paths:
      - src-tauri/target/release/bundle/nsis/*.exe
      - src-tauri/target/release/bundle/msi/*.msi
    expire_in: 1 week
  only:
    - main
    - tags

release:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        curl --request POST \
          --header "PRIVATE-TOKEN: ${CI_JOB_TOKEN}" \
          --form "name=Sigil ${CI_COMMIT_TAG}" \
          --form "tag_name=${CI_COMMIT_TAG}" \
          --form "description=Release ${CI_COMMIT_TAG}" \
          "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"
      fi
  dependencies:
    - build:windows
  only:
    - tags

